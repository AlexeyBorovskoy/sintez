# Решение проблемы активации жёлтого мигания

**Дата:** 2026-02-03  
**Проблема:** Жёлтое мигание не активируется визуально на контроллере, несмотря на успешные SNMP SET операции

---

## Краткое резюме решения

**Логика работы жёлтого мигания:**

1. **Активация (0-60 секунд):**
   - При получении команды SET_YF запускается механизм удержания на 1 минуту
   - Каждые 2 секунды отправляется SNMP SET (operationMode=3, utcControlFF=1)
   - Контроллер переходит в режим жёлтого мигания

2. **Автоматическое отключение (после 60 секунд):**
   - После истечения 1 минуты автоматически отправляется команда отключения
   - SNMP SET (operationMode=3, utcControlFF=0) - 3 попытки с интервалом 2 секунды
   - Восстановление режима работы контроллера (если был изменён)

3. **Результат:**
   - Контроллер работает в режиме жёлтого мигания ровно 1 минуту
   - После этого автоматически возвращается в обычный режим работы
   - Не требует дополнительных команд от АСУДД

---

## Анализ проблемы

### Текущая ситуация

**Что работает:**
- SNMP SET операция для `utcControlFF` выполняется успешно
- Контроллер подтверждает приём команды (SNMP Response успешен)
- OID используется правильно (без SCN): `1.3.6.1.4.1.13267.3.2.4.2.1.20`
- Тип данных правильный: Integer, значение 1

**Что не работает:**
- Визуально жёлтое мигание не активируется на контроллере
- `utcReplyFR` (OID `1.3.6.1.4.1.13267.3.2.5.1.1.36`) остаётся равным 0
- `utcControlFF` является write-only объектом (нельзя прочитать текущее значение)

### Требования из документации

**Из protocol.txt (SetAF):**
```
"Where a condition '1' exists for a minimum of 10 seconds,
the signals shall be set to flashing amber during
a nominated stage provided that all minimum running periods have expired."
```

**Ключевые условия:**
1. **Команда должна быть активна минимум 10 секунд** - это критическое требование
2. **"nominated stage"** - контроллер должен находиться в определённой фазе
3. **"all minimum running periods have expired"** - все минимальные периоды работы фаз должны истечь

### Гипотеза о проблеме

**Контроллер игнорирует команды во время переходных процессов:**

1. **Переходы между фазами (transitions):**
   - Во время смены фаз контроллер может быть занят обработкой переходных процессов
   - Внешние команды могут игнорироваться для обеспечения безопасности

2. **Минимальные периоды работы фаз:**
   - Каждая фаза имеет минимальное время работы
   - До истечения этого периода контроллер не может переключиться в другой режим
   - Команда мигания может быть отложена до истечения периода

3. **Однократная отправка команды:**
   - Текущая реализация отправляет команду один раз
   - Если команда пришла в неподходящий момент, она теряется
   - Документация требует **минимум 10 секунд активности** - это означает, что команда должна быть **активна** в течение этого времени, а не просто отправлена один раз

---

## Описание решения

### Основная идея

**Механизм удержания команды с автоматическим возвратом (Command Hold Mechanism with Auto-Return):**

Вместо однократной отправки SNMP SET команды, необходимо реализовать механизм, который будет:
1. **Удерживать команду активной** в течение 1 минуты (60 секунд) путём периодической повторной отправки SNMP SET запросов
2. **Автоматически отключать мигание** после 1 минуты (SET utcControlFF = 0)
3. **Возвращать контроллер в обычный режим работы** (текущий режим, который был до активации мигания)

### Принцип работы

**1. Инициация удержания команды:**

Когда роутер получает команду SET_YF от АСУДД:
- Сохранить текущий режим работы контроллера (для последующего восстановления)
- Не отправлять команду один раз и завершать операцию
- Вместо этого запустить фоновый процесс удержания команды
- Установить флаг активного удержания команды мигания
- Запустить таймер на 60 секунд (1 минута активного мигания)

**2. Периодическая отправка команды включения мигания:**

В фоновом потоке удержания (фаза активации, 0-60 секунд):
- Каждые 2 секунды отправлять SNMP SET запрос с параметрами:
  - `operationMode = 3` (remote режим)
  - `utcControlFF = 1` (включить мигание)
- Продолжать отправку до истечения таймера (60 секунд)
- Логировать каждую попытку отправки и результат
- Мониторить активацию мигания через `utcReplyFR`

**3. Проверка состояния контроллера (опционально, но рекомендуется):**

Перед каждой отправкой команды:
- Выполнить SNMP GET для получения текущей фазы (`utcReplyGn`)
- Проверить, находится ли контроллер в переходном процессе:
  - Если фаза только что изменилась (transition period) - пропустить эту итерацию
  - Если контроллер в стабильной фазе - отправить команду
- Это поможет избежать отправки команд в неподходящие моменты

**4. Мониторинг активации:**

Параллельно с удержанием команды:
- Периодически (каждые 3-5 секунд) выполнять SNMP GET для `utcReplyFR`
- Если `utcReplyFR` изменился на 1 - мигание активировано, можно прекратить удержание раньше
- Логировать изменения состояния для анализа

**5. Автоматическое отключение мигания (после 1 минуты):**

После истечения 60 секунд удержания:
- Отправить SNMP SET запрос для отключения мигания:
  - `operationMode = 3` (remote режим)
  - `utcControlFF = 0` (выключить мигание)
- Повторить отправку команды отключения 2-3 раза с интервалом 2 секунды (для надёжности)
- Восстановить режим работы контроллера (если был изменён):
  - Если был сохранён режим отличный от 3, вернуть его
  - Иначе оставить режим 3 (remote)

**6. Остановка удержания (прерывание):**

Удержание команды может быть прервано в следующих случаях:
- **При новой команде:** получена команда SET_PHASE, SET_LOCAL или другая команда управления
  - В этом случае: немедленно отключить мигание (utcControlFF = 0) и выполнить новую команду
- **При критической ошибке:** множественные последовательные ошибки SNMP (например, 5 ошибок подряд)
  - В этом случае: попытаться отключить мигание и логировать ошибку

**6. Обработка ошибок:**

При ошибках SNMP во время удержания:
- Не прекращать удержание сразу
- Логировать ошибку
- Продолжать попытки отправки
- Только при множественных последовательных ошибках (например, 3 подряд) - прекратить удержание

---

## Детальная логика работы

### Последовательность операций

**Шаг 1: Получение команды SET_YF от АСУДД**

```
АСУДД → Роутер: "#15:30:45 SET_YF 12345$A3\r"
Роутер: Парсинг команды → вызов setYF(requestId="12345")
```

**Шаг 2: Запуск механизма удержания**

```
setYF() выполняет:
1. Проверка: не активна ли уже команда удержания?
   - Если активна → остановить предыдущую
2. Установка флага: yfHoldActive_ = true
3. Запуск фонового потока: yfHoldThread_
4. Немедленная отправка первой команды SNMP SET
5. Возврат успешного ответа АСУДД: ">O.K. 12345"
```

**Шаг 3: Работа фонового потока удержания**

```
yfHoldThread выполняет цикл:

Начало: startTime = текущее время
Таймаут активации: 60 секунд (1 минута)
Интервал отправки: 2 секунды
Сохранённый режим: savedOperationMode = текущий режим (если не 3)

ФАЗА 1: Активация мигания (0-60 секунд)

Пока (не остановлено И время < 60 секунд):
  1. Проверка текущей фазы (опционально):
     - GET utcReplyGn
     - Если фаза только что изменилась → пропустить итерацию
     
  2. Отправка SNMP SET (включение мигания):
     - operationMode = 3
     - utcControlFF = 1
     - Логирование: "YF Hold: активация #N (время: X сек)"
     
  3. Проверка результата:
     - Если успех → продолжить
     - Если ошибка → увеличить счётчик ошибок
     
  4. Проверка активации (опционально):
     - GET utcReplyFR
     - Если utcReplyFR == 1 → мигание активировано
     
  5. Пауза: 2 секунды
  6. Переход к следующей итерации

ФАЗА 2: Отключение мигания (после 60 секунд)

1. Логирование: "YF Hold: начало отключения мигания"
2. Отправка команды отключения (3 попытки с интервалом 2 сек):
   
   Для i = 1 до 3:
     - Отправка SNMP SET:
       - operationMode = 3
       - utcControlFF = 0
     - Логирование: "YF Hold: отключение #i"
     - Пауза: 2 секунды
   
3. Восстановление режима работы (если нужно):
   - Если savedOperationMode != 3:
     - Отправка SNMP SET: operationMode = savedOperationMode
     - Логирование: "YF Hold: восстановлен режим X"

Конец цикла:
- yfHoldActive_ = false
- Логирование: "YF Hold: завершено (время: 60 секунд)"
```

**Шаг 4: Автоматическое отключение мигания (после 60 секунд)**

```
После завершения фазы активации (60 секунд):

1. Логирование начала отключения:
   "YF Hold: начало отключения мигания (время: 60s)"

2. Отправка команды отключения (3 попытки):
   
   Для i = 1 до 3:
     - Формирование SNMP SET:
       - operationMode = 3
       - utcControlFF = 0
     - Отправка SNMP SET
     - Логирование: "YF Hold: отключение #i"
     - Пауза: 2 секунды между попытками
   
3. Восстановление режима работы:
   - Если savedOperationMode != 3:
     - Отправка SNMP SET: operationMode = savedOperationMode
     - Логирование: "YF Hold: восстановлен режим X"
   - Иначе:
     - Оставить режим 3 (remote)

4. Завершение:
   - yfHoldActive_ = false
   - Логирование: "YF Hold: завершено, мигание отключено"
```

**Шаг 5: Прерывание удержания (при новой команде)**

```
При получении SET_PHASE или SET_LOCAL во время удержания:

1. Установка флага: yfStop_ = true
2. Немедленное отключение мигания:
   - Отправка SNMP SET: utcControlFF = 0 (1-2 попытки)
3. Восстановление режима работы (если нужно)
4. Ожидание завершения потока удержания (join, с таймаутом)
5. Выполнение новой команды
```

---

## Полный цикл работы жёлтого мигания

### Временная диаграмма

```
Время:  0s    10s    30s    60s    66s
        |      |      |      |      |
АСУДД:  SET_YF ──────────────────────►
        |
Роутер: ┌─────────────────────────────┐
        │ ФАЗА 1: Активация мигания    │
        │ (0-60 секунд)                │
        │                               │
        │ Каждые 2 сек:                 │
        │   SET operationMode=3         │
        │   SET utcControlFF=1          │
        │                               │
        │   [Отправка #1]               │
        │   [Отправка #2]                │
        │   ...                          │
        │   [Отправка #30]              │
        └───────────────────────────────┘
                                      │
                                      ▼
        ┌─────────────────────────────┐
        │ ФАЗА 2: Отключение мигания  │
        │ (60-66 секунд)              │
        │                               │
        │ Попытка 1:                    │
        │   SET operationMode=3         │
        │   SET utcControlFF=0          │
        │                               │
        │ Попытка 2:                    │
        │   SET operationMode=3         │
        │   SET utcControlFF=0          │
        │                               │
        │ Попытка 3:                    │
        │   SET operationMode=3         │
        │   SET utcControlFF=0          │
        │                               │
        │ Восстановление режима:         │
        │   SET operationMode=saved      │
        └───────────────────────────────┘
                                      │
Контроллер:                          │
  Мигание:  ────────[АКТИВНО]────────┘
            (визуально видно)
```

### Описание фаз

**ФАЗА 1: Активация и удержание мигания (0-60 секунд)**

- **Цель:** Активировать жёлтое мигание и удерживать его активным в течение 1 минуты
- **Действия:**
  - Периодическая отправка SNMP SET (operationMode=3, utcControlFF=1)
  - Интервал: каждые 2 секунды
  - Количество отправок: ~30 раз (60 сек / 2 сек)
- **Результат:** Контроллер переходит в режим жёлтого мигания

**ФАЗА 2: Отключение мигания и восстановление (60-66 секунд)**

- **Цель:** Отключить мигание и вернуть контроллер в обычный режим работы
- **Действия:**
  - Отправка SNMP SET для отключения (utcControlFF=0) - 3 попытки
  - Восстановление режима работы (если был изменён)
- **Результат:** Контроллер возвращается в обычный режим работы

---

## Преимущества решения

### 1. Соответствие документации

- **Требование:** команда должна быть активна минимум 10 секунд
- **Решение:** команда отправляется каждые 2 секунды в течение 15 секунд
- **Результат:** команда гарантированно активна требуемое время

### 2. Устойчивость к переходным процессам

- **Проблема:** контроллер игнорирует команды во время переходов
- **Решение:** периодическая отправка увеличивает вероятность попадания команды в "окно" между переходами
- **Результат:** даже если несколько команд проигнорированы, последующие будут обработаны

### 3. Мониторинг и диагностика

- **Логирование:** каждая попытка отправки логируется
- **Отслеживание состояния:** проверка utcReplyFR позволяет определить момент активации
- **Анализ:** можно определить, в какие моменты команды игнорируются

### 4. Гибкость

- **Автоматическое отключение:** после 1 минуты мигание автоматически отключается
- **Восстановление режима:** контроллер возвращается в обычный режим работы
- **Обработка ошибок:** множественные ошибки не приводят к бесконечным попыткам
- **Прерывание:** новая команда корректно останавливает удержание и отключает мигание

### 5. Автоматизация

- **Полный цикл:** активация → удержание → отключение происходит автоматически
- **Не требует вмешательства:** после команды SET_YF весь процесс выполняется автоматически
- **Предсказуемость:** длительность мигания всегда ровно 1 минута

---

## Параметры реализации

### Временные параметры

- **Длительность активации мигания:** 60 секунд (1 минута)
- **Интервал отправки команды включения:** 2 секунды (компромисс между надёжностью и нагрузкой)
- **Количество попыток отключения:** 3 попытки с интервалом 2 секунды
- **Интервал проверки состояния:** 3-5 секунд (для проверки utcReplyFR)
- **Таймаут SNMP операции:** 5-10 секунд (стандартный)

### Пороговые значения

- **Максимум ошибок активации:** 5 последовательных ошибок SNMP → остановка удержания
- **Максимум ошибок отключения:** 3 последовательные ошибки → логирование предупреждения, но продолжение
- **Проверка переходов:** если фаза изменилась менее 1 секунды назад → пропустить отправку
- **Ранняя остановка:** НЕ применяется - мигание должно работать полные 60 секунд

### Логирование

**Уровни логирования:**
- **INFO:** Запуск/остановка удержания, успешные отправки
- **DEBUG:** Каждая попытка отправки, результаты GET операций
- **WARNING:** Ошибки SNMP, пропуски из-за переходных процессов
- **ERROR:** Критические ошибки, множественные сбои

**Формат логов:**
```
[YF_HOLD] Start: requestId=12345, duration=60s, savedMode=3
[YF_HOLD] Activate #1: success, phase=3, elapsed=2s
[YF_HOLD] Activate #2: success, phase=3, elapsed=4s
[YF_HOLD] Check: utcReplyFR=0 (not activated yet)
[YF_HOLD] Activate #3: success, phase=4, elapsed=6s
[YF_HOLD] Check: utcReplyFR=1 (ACTIVATED!)
[YF_HOLD] Activate #15: success, phase=2, elapsed=30s
[YF_HOLD] Activate #30: success, phase=1, elapsed=60s
[YF_HOLD] Deactivate #1: success, utcControlFF=0
[YF_HOLD] Deactivate #2: success, utcControlFF=0
[YF_HOLD] Deactivate #3: success, utcControlFF=0
[YF_HOLD] Restore mode: operationMode=3
[YF_HOLD] Complete: total time=66s
```

---

## Альтернативные подходы (если основное решение не поможет)

### Альтернатива 1: Увеличение длительности удержания

Если 15 секунд недостаточно:
- Увеличить до 20-30 секунд
- Уменьшить интервал отправки до 1 секунды
- Более агрессивное удержание команды

### Альтернатива 2: Предварительная подготовка

Перед активацией мигания:
1. Установить определённую фазу (например, фазу 1)
2. Дождаться стабилизации (5-10 секунд)
3. Затем начать удержание команды мигания

### Альтернатива 3: Комбинация команд

Вместо только utcControlFF:
1. Сначала установить фазу (SET_PHASE на определённую фазу)
2. Дождаться активации фазы
3. Затем начать удержание команды мигания

### Альтернатива 4: Использование других OID

Проверить возможность использования:
- `vlnkSetPhaseTrue` (1.3.6.1.4.1.13267.3.2.4.2.1.15) - разрешение установки фазы
- Другие OID из MIB, связанные с миганием

---

## План тестирования

### Этап 1: Базовая проверка

1. Запустить удержание команды на 60 секунд
2. Визуально контролировать контроллер в течение всего цикла:
   - Активация мигания (первые 10-30 секунд)
   - Удержание мигания (30-60 секунд)
   - Отключение мигания (после 60 секунд)
   - Возврат в обычный режим
3. Проверить логи отправки команд (активация и отключение)
4. Определить, активировалось ли мигание и отключилось ли автоматически

### Этап 2: Анализ моментов активации

1. Логировать текущую фазу перед каждой отправкой
2. Определить, в каких фазах команда принимается
3. Выявить паттерны переходных процессов

### Этап 3: Оптимизация параметров

1. Подобрать оптимальный интервал отправки (возможно 1-3 секунды)
2. Проверить необходимость проверки состояния перед отправкой
3. Оптимизировать количество попыток отключения (возможно достаточно 2 попыток)
4. Проверить необходимость восстановления режима работы

### Этап 4: Проверка надёжности

1. Множественные активации подряд (несколько циклов 60 секунд)
2. Активация во время разных фаз
3. Активация во время переходных процессов
4. Прерывание удержания новой командой (SET_PHASE, SET_LOCAL)
5. Обработка ошибок SNMP во время активации и отключения
6. Проверка восстановления режима работы после отключения

---

## Ожидаемые результаты

### После реализации решения

1. **Визуальная активация:** жёлтое мигание должно активироваться на контроллере
2. **Автоматическое отключение:** после 1 минуты мигание должно автоматически отключиться
3. **Восстановление режима:** контроллер должен вернуться в обычный режим работы
4. **Стабильность:** весь цикл (активация → удержание → отключение) должен работать стабильно
5. **Диагностика:** логи должны показывать все этапы процесса

### Метрики успеха

- **Процент успешных активаций:** > 90% при правильных условиях
- **Время до активации:** обычно 10-15 секунд (в пределах первых 60 секунд)
- **Длительность мигания:** ровно 60 секунд (1 минута)
- **Количество отправок активации:** ~30 SNMP SET запросов за цикл (60 сек / 2 сек)
- **Количество отправок отключения:** 3 попытки
- **Успешное восстановление режима:** 100% случаев
- **Ложные срабатывания:** отсутствие активации при неподходящих условиях

---

## Риски и ограничения

### Потенциальные проблемы

1. **Нагрузка на контроллер:**
   - Частые SNMP запросы могут создавать нагрузку
   - Решение: интервал 2 секунды - разумный компромисс

2. **Конфликты команд:**
   - Если приходит SET_PHASE во время удержания SET_YF
   - Решение: корректная остановка удержания при новой команде

3. **Неопределённость "nominated stage":**
   - Неизвестно, какая именно фаза является "nominated"
   - Решение: удержание команды в течение всего цикла фаз

4. **Неизвестные минимальные периоды:**
   - Неизвестны точные значения минимальных периодов
   - Решение: запас в 15 секунд должен покрыть большинство случаев

---

## Выводы

### Основное решение

**Механизм удержания команды с автоматическим отключением** является решением проблемы активации жёлтого мигания:

1. **Активация:** удержание команды включения мигания в течение 1 минуты (60 секунд) с периодической отправкой SNMP SET запросов
2. **Автоматическое отключение:** после 60 секунд автоматическое отключение мигания (utcControlFF = 0)
3. **Восстановление режима:** возврат контроллера в обычный режим работы (сохранённый до активации)
4. **Соответствие требованиям:** команда активна минимум 10 секунд (фактически 60 секунд)
5. **Устойчивость:** периодическая отправка учитывает игнорирование команд во время переходных процессов
6. **Мониторинг:** логирование всех этапов процесса для диагностики

### Следующие шаги

1. Реализовать механизм удержания команды с автоматическим отключением:
   - Фаза активации (0-60 сек): периодическая отправка utcControlFF = 1
   - Фаза отключения (после 60 сек): отправка utcControlFF = 0
   - Восстановление режима работы
2. Сохранение и восстановление режима работы контроллера
3. Добавить логирование всех операций (активация, удержание, отключение)
4. Провести тестирование на реальном контроллере:
   - Визуальная проверка активации мигания
   - Проверка автоматического отключения через 1 минуту
   - Проверка восстановления обычного режима
5. Анализировать логи для оптимизации параметров
6. При необходимости применить альтернативные подходы

---

**Статус:** Готово к реализации  
**Приоритет:** Высокий (основная проблема проекта)
