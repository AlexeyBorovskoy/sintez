# Диагностика проблемы с жёлтым миганием

**Дата:** 2026-02-04  
**Проблема:** Команды SET_YF не активируют жёлтое мигание визуально на контроллере

---

## Архитектура работы системы

### Как работает АСУДД:

```
АСУДД Сервер (commserver.cudd:3000)
    │
    │ TCP/IP (Spectr-ITS протокол)
    │ Команда: SET_YF
    │
    ▼
spectr_utmc.js на контроллере (TCP клиент)
    │
    │ Преобразование команды в SNMP
    │
    ▼
SNMP SET → snmp_agent (127.0.0.1) ← ЛОКАЛЬНЫЙ СЕРВИС!
    │
    │ Обработка SNMP команды
    │
    ▼
resident (основной процесс контроллера)
    │
    ▼
Визуальное жёлтое мигание ✅
```

### Как мы тестируем:

```
Наш тест (внешний компьютер)
    │
    │ SNMP SET напрямую
    │
    ▼
Контроллер (192.168.75.150) ← ВНЕШНИЙ ИСТОЧНИК!
    │
    │ ???
    │
    ▼
snmp_agent
    │
    │ Возможно, отклоняет команды от внешних источников?
    │
    ▼
❌ Мигание НЕ активируется
```

---

## Возможные причины проблемы

### 1. Контроллер принимает команды только от локального сервиса

**Гипотеза:** `snmp_agent` проверяет источник SNMP команды и принимает только команды от локального сервиса (127.0.0.1), а не от внешних источников.

**Проверка:**
- SNMP команды от `spectr_utmc.js` (127.0.0.1) → ✅ Работают
- SNMP команды от внешних источников (192.168.75.150) → ❌ Не работают

**Решение:**
- Отправлять команды через `spectr_utmc.js` на контроллере
- Или настроить `snmp_agent` для приёма команд от внешних источников

### 2. Требуется предварительная настройка или условие

**Гипотеза:** Контроллер требует выполнения каких-то условий перед активацией мигания:
- Режим работы (UTC Control)
- Активная фаза
- Истёкшие минимальные периоды
- Отсутствие переходных процессов

**Проверка:**
- Мы уже проверяем эти условия в C++ коде
- Но возможно, контроллер требует дополнительных условий

**Решение:**
- Проверить логи контроллера на предмет ошибок
- Проверить конфигурацию контроллера

### 3. Защита от удалённого управления

**Гипотеза:** Контроллер имеет защиту "Deny the remote controll in case of amber flash error: True", которая блокирует команды от внешних источников.

**Проверка:**
- Из анализа контроллера: `"remote_onoff": false`
- Это может означать, что удалённое управление отключено

**Решение:**
- Включить удалённое управление через веб-интерфейс контроллера
- Или отправлять команды через локальный сервис

---

## Рекомендации по решению

### Вариант 1: Использовать spectr_utmc.js на контроллере

Если `spectr_utmc.js` работает на контроллере, можно:
1. Подключиться к нему через SSH
2. Отправить команду SET_YF через протокол Spectr-ITS
3. `spectr_utmc.js` преобразует команду в SNMP и отправит на локальный `snmp_agent`

**Проблема:** Нужен доступ к контроллеру по SSH или возможность отправки команд через TCP/IP на `spectr_utmc.js`.

### Вариант 2: Настроить snmp_agent для приёма внешних команд

Если возможно настроить `snmp_agent` для приёма команд от внешних источников:
1. Проверить конфигурацию `snmp_agent`
2. Настроить приём команд от определённых IP-адресов
3. Или отключить проверку источника команды

**Проблема:** Требуется доступ к конфигурации `snmp_agent` на контроллере.

### Вариант 3: Использовать веб-интерфейс контроллера

Если контроллер имеет веб-интерфейс для управления:
1. Отправить команду SET_YF через веб-интерфейс
2. Проверить, активируется ли мигание
3. Если да, использовать веб-интерфейс для управления

**Проблема:** Требуется знание API веб-интерфейса.

---

## Следующие шаги

1. **Проверить, работает ли `spectr_utmc.js` на контроллере:**
   ```bash
   ssh voicelink@192.168.75.150 "ps aux | grep spectr_utmc"
   ```

2. **Проверить, может ли контроллер принимать SNMP команды от внешних источников:**
   - Попробовать отправить простую SNMP GET команду
   - Если GET работает, но SET не работает, проблема в обработке SET команд

3. **Проверить логи контроллера:**
   - Найти логи `snmp_agent` или `resident`
   - Проверить, есть ли ошибки при получении SNMP SET команд

4. **Проверить конфигурацию контроллера:**
   - Проверить настройки удалённого управления
   - Проверить защиту от ошибок мигания

---

## Вывод

Основная проблема: **Контроллер принимает SNMP команды только от локального сервиса (127.0.0.1), а не от внешних источников.**

Это объясняет, почему команды от АСУДД работают (через `spectr_utmc.js` на контроллере), а наши прямые SNMP команды не работают.

**Решение:** Отправлять команды через `spectr_utmc.js` на контроллере, либо настроить контроллер для приёма команд от внешних источников.
