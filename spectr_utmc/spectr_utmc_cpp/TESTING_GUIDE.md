# Руководство по тестированию полной интеграции

**Дата:** 2026-02-04  
**Цель:** Тестирование полного взаимодействия АСУДД → C++ мост → Контроллер

---

## Архитектура тестирования

```
Тестовый АСУДД сервер (127.0.0.1:3000)
    │
    │ TCP/IP (Spectr-ITS протокол)
    │ Команда: SET_YF
    │
    ▼
C++ мост (spectr_utmc_cpp)
    │
    │ Преобразование команды в SNMP
    │
    ▼
Контроллер (192.168.75.150)
    │
    │ SNMP SET
    │
    ▼
snmp_agent → resident
    │
    ▼
Визуальное жёлтое мигание ✅
```

---

## Быстрый старт

### Вариант 1: Автоматический тест (рекомендуется)

```bash
cd /home/alexey/shared_vm/spectr_utmc/spectr_utmc/spectr_utmc_cpp
./test_full_integration.sh
```

Этот скрипт автоматически:
1. Компилирует C++ код
2. Запускает тестовый АСУДД сервер
3. Запускает C++ мост
4. Отправляет команду SET_YF
5. Проверяет результат

### Вариант 2: Ручной запуск

#### Шаг 1: Запуск тестового АСУДД сервера

```bash
cd /home/alexey/shared_vm/spectr_utmc/spectr_utmc/spectr_utmc_cpp
python3 test_asudd_server.py start --interactive
```

Сервер запустится на порту 3000 и будет ждать подключений.

#### Шаг 2: Запуск C++ моста

В другом терминале:

```bash
cd /home/alexey/shared_vm/spectr_utmc/spectr_utmc/spectr_utmc_cpp/build
./spectr_utmc_cpp ../config_test.json
```

C++ мост подключится к тестовому АСУДД серверу.

#### Шаг 3: Отправка команды SET_YF

В терминале с АСУДД сервером (интерактивный режим):

```
ASUDD> SET_YF TEST001
```

Или в автоматическом режиме (без интерактивного режима):

```bash
# В другом терминале отправьте команду через netcat или другой инструмент
echo -e "#$(date +%H:%M:%S) SET_YF TEST001\$XX\r" | nc 127.0.0.1 3000
```

#### Шаг 4: Проверка результата

```bash
cd /home/alexey/shared_vm/spectr_utmc/spectr_utmc/AI_reaserh
node utmc-tester.js --ip 192.168.75.150 --community UTMC --status
```

Проверьте:
- Режим работы контроллера
- Режим мигания (utcReplyFR)
- Визуально на контроллере: должно быть жёлтое мигание

---

## Доступные команды в интерактивном режиме

После запуска `python3 test_asudd_server.py start --interactive`:

- `SET_YF [REQUEST_ID]` - Включить жёлтое мигание
- `SET_PHASE <N> [REQUEST_ID]` - Установить фазу N
- `GET_STAT [REQUEST_ID]` - Получить статус контроллера
- `SET_LOCAL [REQUEST_ID]` - Перевести в локальный режим
- `quit` - Выход

Примеры:

```
ASUDD> SET_YF TEST001
ASUDD> SET_PHASE 1 TEST002
ASUDD> GET_STAT TEST003
ASUDD> SET_LOCAL TEST004
ASUDD> quit
```

---

## Проверка работы

### 1. Проверка подключения C++ моста к АСУДД серверу

В логах АСУДД сервера должно быть:
```
[HH:MM:SS] Клиент подключен: ('127.0.0.1', XXXXX)
```

В логах C++ моста должно быть:
```
Connected to 127.0.0.1:3000
```

### 2. Проверка получения команды

В логах C++ моста должно быть:
```
Получена команда: SET_YF
```

### 3. Проверка отправки SNMP команды

В логах C++ моста должно быть:
```
Отправка SNMP SET: operationMode=3, utcControlFF=1
```

### 4. Проверка результата на контроллере

```bash
cd /home/alexey/shared_vm/spectr_utmc/spectr_utmc/AI_reaserh
node utmc-tester.js --ip 192.168.75.150 --community UTMC \
    --raw-get "1.3.6.1.4.1.13267.3.2.5.1.1.36"
```

Должно вернуть: `Value: 1` (мигание активно)

---

## Устранение неполадок

### Проблема: C++ мост не подключается к АСУДД серверу

**Решение:**
1. Проверьте, что АСУДД сервер запущен: `lsof -i :3000`
2. Проверьте конфигурацию: `cat config_test.json`
3. Проверьте логи C++ моста на наличие ошибок подключения

### Проблема: Команды не доходят до контроллера

**Решение:**
1. Проверьте, что контроллер доступен: `ping 192.168.75.150`
2. Проверьте SNMP доступность: `snmpget -v2c -c UTMC 192.168.75.150 1.3.6.1.2.1.1.3.0`
3. Проверьте логи C++ моста на наличие ошибок SNMP

### Проблема: Мигание не активируется визуально

**Решение:**
1. Проверьте режим работы контроллера (должен быть UTC Control (3))
2. Проверьте текущую фазу (должна быть специальная фаза 1-4)
3. Проверьте, что истёк минимальный период работы фазы
4. Проверьте логи контроллера на наличие ошибок

---

## Следующие шаги

После успешного тестирования:

1. **Оптимизация логики SET_YF:**
   - Проверка условий перед активацией мигания
   - Автоматическое восстановление режима после мигания

2. **Добавление других команд:**
   - SET_PHASE
   - SET_LOCAL
   - GET_STAT
   - И другие

3. **Подготовка к развёртыванию на роутере iRZ:**
   - Компиляция для OpenWRT
   - Создание пакета для установки
   - Настройка автозапуска

---

## Контакты и поддержка

При возникновении проблем:
1. Проверьте логи всех компонентов
2. Проверьте конфигурацию
3. Проверьте сетевую доступность
4. Проверьте документацию в `YELLOW_FLASHING_DIAGNOSIS.md`
