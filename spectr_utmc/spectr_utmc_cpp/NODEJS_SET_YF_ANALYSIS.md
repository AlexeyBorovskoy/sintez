# Анализ реализации SET_YF в оригинальном Node.js коде

## Найденная реализация

Из минифицированного кода `spectr_utmc.js` извлечена функция `SET_YF`:

```javascript
SET_YF(e){
    return this.set(e,[
        {oid:l.utcType2OperationMode,type:u,value:3},
        {oid:l.utcControlFF,type:u,value:1}
    ])
}
```

Где:
- `l.utcType2OperationMode` = `"1.3.6.1.4.1.13267.3.2.4.1"` (режим работы)
- `l.utcControlFF` = `"1.3.6.1.4.1.13267.3.2.4.2.1.20"` (контроль мигания)
- `u` = `Integer` (тип данных)
- `e` = requestId (идентификатор запроса)

## Ключевые наблюдения

### 1. Однократная отправка команды
- **НЕТ механизма удержания команды** - команда отправляется один раз
- **НЕТ периодической повторной отправки**
- **НЕТ проверки условий перед отправкой**

### 2. Последовательность команд
Команда отправляется как **одна SNMP SET операция** с двумя varbinds:
1. `operationMode = 3` (UTC Control)
2. `utcControlFF = 1` (включить мигание)

### 3. Отсутствие предварительной подготовки
- **НЕТ** проверки текущего режима работы
- **НЕТ** перевода в режим UTC Control перед отправкой
- **НЕТ** проверки текущей фазы
- **НЕТ** ожидания истечения минимальных периодов

## Выводы

### Что это означает?

1. **Оригинальный код тоже отправляет команду один раз** - значит, проблема не в отсутствии удержания команды

2. **Возможные причины, почему это работает в оригинальной системе:**
   - Контроллер уже находится в режиме UTC Control (3) постоянно
   - Контроллер уже имеет активную фазу и истёкшие минимальные периоды
   - АСУДД система отправляет команду в подходящий момент (когда контроллер готов)
   - Контроллер работает в другом режиме/конфигурации

3. **Почему наша реализация не работает:**
   - Контроллер находится в режиме Standalone (1), а не UTC Control (3)
   - Возможно, контроллер не имеет активной фазы в момент отправки команды
   - Возможно, минимальные периоды работы фаз не истекли

## Рекомендации

### Вариант 1: Точное копирование логики
Использовать точно такую же логику, как в оригинальном коде:
- Однократная отправка команды
- Без предварительных проверок
- Без удержания команды

**НО:** Это может не работать, если контроллер не готов принять команду.

### Вариант 2: Улучшенная логика (текущая реализация)
- Проверка режима работы
- Перевод в режим UTC Control перед отправкой
- Удержание команды для надёжности

**НО:** Это тоже не работает визуально.

### Вариант 3: Проверка условий перед отправкой
Перед отправкой команды SET_YF:
1. Убедиться, что контроллер в режиме UTC Control (3)
2. Убедиться, что есть активная фаза
3. Убедиться, что истёк минимальный период работы фазы
4. Только тогда отправить команду

### Вариант 4: Использование других команд
Возможно, нужно сначала установить фазу, а затем активировать мигание:
1. `SET_PHASE` на определённую фазу
2. Дождаться активации фазы
3. Затем `SET_YF`

## Следующие шаги

1. Проверить, в каком режиме работает контроллер в реальной АСУДД системе
2. Проверить, есть ли активная фаза в момент отправки команды SET_YF
3. Попробовать комбинацию команд: SET_PHASE → SET_YF
4. Проверить, может ли контроллер активировать мигание только в определённых фазах
