# Анализ проблемы StageDemandBits

**Дата:** 2026-02-03  
**OID:** `1.3.6.1.4.1.13267.3.2.4.2.1.4`  
**Проблема:** "No Such Object available on this agent at this OID"

---

## Найденная информация

### 1. Документация protocol.txt

**Важное замечание:**
```
OID с именами 'SysDescr', 'Uptime', 'GetVersion', 'GetPhase', 'GetError', 
'GetWarnings', 'GetRCP', 'GetAF', 'SetPhase', 'StageDemandBits', 'SetPhaseTrue', 
'SetAF', 'SetOFF', 'GetOFF' работают с передачей SCN
```

**Вывод:** StageDemandBits **требует передачи SCN** (Site Control Number)!

### 2. MIB файл (UTMC-UTMCFULLUTCTYPE2-MIB)

**Структура таблицы:**
```
utcControlTable (1.3.6.1.4.1.13267.3.2.4.2)
  └── utcControlEntry (1.3.6.1.4.1.13267.3.2.4.2.1)
      INDEX { utcControlTimeStamp, utcControlSiteID }
      ├── utcControlTimeStamp (1.3.6.1.4.1.13267.3.2.4.2.1.1)
      ├── utcControlSiteID (1.3.6.1.4.1.13267.3.2.4.2.1.2)  ← SCN здесь!
      ├── utcControlDX (1.3.6.1.4.1.13267.3.2.4.2.1.3)
      ├── utcControlDn (1.3.6.1.4.1.13267.3.2.4.2.1.4)  ← StageDemandBits!
      └── ...
```

**Ключевая информация:**
- `utcControlDn` (StageDemandBits) находится в **таблице** `utcControlTable`
- Таблица имеет **INDEX**: `{ utcControlTimeStamp, utcControlSiteID }`
- Это означает, что для доступа к этой таблице нужны **индексы**:
  1. **Timestamp** (секунды дня, обычно 1 = "now")
  2. **SiteID** (SCN - Site Control Number)

### 3. Формат SCN

Из protocol.txt:
```
SCN = COX, где "CO" обязательные символы латинскими буквами, 
а X - число от 1 до 9999
```

Пример: `CO1111`, `CO1`, `CO9999`

### 4. Правильный формат OID для таблицы

Для доступа к элементу таблицы в SNMP нужно указать индексы после OID:

```
Базовый OID: 1.3.6.1.4.1.13267.3.2.4.2.1.4
С индексами: 1.3.6.1.4.1.13267.3.2.4.2.1.4.<timestamp>.<siteID>
```

Где:
- `<timestamp>` - секунды дня (обычно 1 для "now")
- `<siteID>` - SCN в формате ASCII строки (например, "CO1111")

---

## Проблема в текущем тесте

**Что мы делали:**
```bash
./build/test_controller get 192.168.75.150 UTMC 1.3.6.1.4.1.13267.3.2.4.2.1.4
```

**Почему не работает:**
- Мы указали только базовый OID без индексов таблицы
- Контроллер не может найти элемент таблицы без индексов
- Нужно указать timestamp и SCN

---

## Решение

### Вариант 1: Использовать правильный формат OID с индексами

Для получения StageDemandBits нужно использовать формат:
```
1.3.6.1.4.1.13267.3.2.4.2.1.4.<timestamp>.<siteID>
```

Где:
- `<timestamp>` = 1 (для "now")
- `<siteID>` = нужно узнать из конфигурации контроллера

**Проблема:** Мы не знаем SCN для контроллера 192.168.75.150

### Вариант 2: Проверить, используется ли StageDemandBits в исходном коде

Нужно проверить, действительно ли исходный Node.js код использует StageDemandBits для чтения, или только для записи.

---

## Рекомендации

1. **Узнать SCN контроллера** из конфигурации или веб-интерфейса
2. **Попробовать стандартные SCN** (если известны)
3. **Проверить исходный код** - возможно, StageDemandBits используется только для SET, а не для GET
4. **Если SCN неизвестен** - пропустить этот тест, так как он требует настройки контроллера

---

## Вывод

**Причина ошибки:** StageDemandBits находится в таблице, которая требует индексов (timestamp и SCN). Без этих индексов контроллер не может найти элемент таблицы.

**Решение:** Либо узнать SCN контроллера и использовать правильный формат OID с индексами, либо пропустить этот тест, если он не критичен для работы приложения.
