# Реальная проблема с жёлтым миганием

**Дата:** 2026-02-04  
**Проблема:** Команды SET_YF не активируют жёлтое мигание, несмотря на то, что:
- ✅ Удалённое управление разрешено
- ✅ Протокол UTMC настроен
- ✅ SNMP команды выполняются успешно (режим меняется)
- ✅ Режимы работы не влияют на ЖМ

---

## Архитектура контроллера

Из анализа контроллера:

```
spectr_utmc.js (на контроллере, 127.0.0.1)
    ↓ SNMP SET (локально)
snmp_agent (127.0.0.1)
    ↓ Обработка команды
resident (основной процесс)
    ↓ Применение команды
Визуальное мигание ✅
```

**Ключевой момент:** `spectr_utmc.js` работает с адресом `127.0.0.1` (локально), а не с внешним IP контроллера.

---

## Гипотеза: Контроллер принимает команды только от локального сервиса

### Подтверждения:

1. **Из анализа контроллера:**
   - `spectr_utmc.js` работает с адресом `127.0.0.1` (локально)
   - SNMP запросы идут к локальному `snmp_agent`
   - `snmp_agent` обрабатывает запросы и передаёт их процессу `resident`

2. **Из настроек SNMP-уведомлений:**
   - IP-адрес получателя: `127.0.0.1` (localhost)
   - Это указывает на локальный сервис

3. **Из работы АСУДД:**
   - АСУДД → TCP/IP (Spectr-ITS) → `spectr_utmc.js` (на контроллере) → SNMP → `snmp_agent` → `resident`
   - Команды проходят через локальный сервис на контроллере

### Проблема:

Когда мы отправляем SNMP команды напрямую на контроллер (192.168.75.150):
- Команды доходят до `snmp_agent`
- `snmp_agent` может принимать команды (режим меняется)
- Но команды SET_YF не активируют мигание

**Возможные причины:**
1. `snmp_agent` проверяет источник команды и принимает только от локального сервиса (127.0.0.1)
2. Команды SET_YF требуют дополнительной обработки через `spectr_utmc.js`
3. `snmp_agent` принимает команды, но не передаёт их процессу `resident` для внешних источников

---

## Решение для работы напрямую с контроллером

### Вариант 1: Использовать локальный сервис на контроллере

Если контроллер принимает команды только от локального сервиса:

1. **Подключиться к контроллеру по SSH:**
   ```bash
   ssh voicelink@192.168.75.150
   ```

2. **Использовать `spectr_utmc.js` на контроллере:**
   - Отправить команду SET_YF через протокол Spectr-ITS
   - `spectr_utmc.js` преобразует команду в SNMP и отправит на локальный `snmp_agent`

3. **Или использовать SNMP напрямую с локального сервиса:**
   - На контроллере выполнить SNMP SET команду к `127.0.0.1`
   - Это должно работать, так как команда идёт от локального источника

### Вариант 2: Настроить контроллер для приёма команд от внешних источников

Если возможно настроить `snmp_agent` для приёма команд от внешних источников:

1. Проверить конфигурацию `snmp_agent` на контроллере
2. Настроить приём команд от определённых IP-адресов
3. Или отключить проверку источника команды

### Вариант 3: Использовать веб-интерфейс для активации ЖМ

Если веб-интерфейс имеет функцию активации жёлтого мигания:

1. Проверить все разделы веб-интерфейса
2. Найти функцию активации жёлтого мигания
3. Использовать её для тестирования

---

## Тестирование гипотезы

### Тест 1: Проверка работы через локальный сервис

Подключиться к контроллеру по SSH и выполнить команду SET_YF локально:

```bash
ssh voicelink@192.168.75.150
# На контроллере:
# Отправить команду SET_YF через spectr_utmc.js или напрямую через SNMP к 127.0.0.1
```

### Тест 2: Проверка конфигурации snmp_agent

Проверить конфигурацию `snmp_agent` на контроллере:

```bash
ssh voicelink@192.168.75.150
# Найти конфигурационные файлы snmp_agent
# Проверить настройки приёма команд от внешних источников
```

---

## Вывод

**Основная проблема:** Контроллер принимает команды SET_YF только от локального сервиса (127.0.0.1), а не от внешних источников.

**Решение для работы напрямую с контроллером:**
1. Использовать локальный сервис на контроллере (`spectr_utmc.js` или SNMP к 127.0.0.1)
2. Или настроить контроллер для приёма команд от внешних источников

**Для production (роутер iRZ):**
- C++ мост на роутере должен работать как прокси
- Получать команды от АСУДД сервера
- Отправлять их на локальный сервис на контроллере (если возможно)
- Или использовать другой механизм (веб-API, если доступен)

---

## Следующие шаги

1. ✅ Проверить, работает ли команда SET_YF через локальный сервис на контроллере
2. ✅ Проверить конфигурацию `snmp_agent` на контроллере
3. ✅ Найти способ отправки команд от роутера iRZ к локальному сервису на контроллере
