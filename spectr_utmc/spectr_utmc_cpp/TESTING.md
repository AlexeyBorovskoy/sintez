# Руководство по тестированию подключения к контроллеру

## Обзор

Утилита `test_controller` предназначена для проверки подключения к SNMP контроллеру и выполнения базовых операций без запуска полного приложения.

## Сборка

```bash
mkdir -p build
cd build
cmake ..
make
```

После сборки будут созданы два исполняемых файла:
- `spectr_utmc_cpp` - основное приложение
- `test_controller` - тестовая утилита

## Использование

### 1. Интерактивный режим (рекомендуется)

```bash
./test_connection.sh
```

Скрипт предложит выбрать режим тестирования:
- Тест с использованием config.json
- Прямое подключение по IP адресу
- Тест приема SNMP traps

### 2. Командная строка

#### Тест с использованием config.json

```bash
./build/test_controller test config.json
```

Выполняет тесты для всех объектов, указанных в конфигурационном файле.

#### Прямое подключение к контроллеру

```bash
./build/test_controller connect <IP_ADDRESS> <COMMUNITY>
```

Пример:
```bash
./build/test_controller connect 192.168.4.77 UTMC
```

Выполняет следующие тесты:
1. Создание SNMP сессии
2. GET запрос: sysUpTime (время работы системы)
3. GET запрос: Application Version (версия ПО контроллера)
4. GET запрос: Operation Mode (режим работы: Standalone/Monitor/UTC Control)
5. GET запрос: Controller Time (время контроллера)

#### Тест приема SNMP traps

```bash
./build/test_controller traps [PORT] [COMMUNITY]
```

Пример:
```bash
./build/test_controller traps 10162 UTMC
```

Запускает приемник SNMP traps на указанном порту и ожидает входящие уведомления от контроллера (30 секунд по умолчанию).

## Что проверяется

### Базовая связность

1. **Создание SNMP сессии** - проверка возможности установить соединение с контроллером
2. **sysUpTime** - время работы системы (стандартный SNMP OID)
3. **Application Version** - версия ПО контроллера (UTMC OID: 1.3.6.1.4.1.13267.3.2.1.2)
4. **Operation Mode** - режим работы контроллера:
   - 1 = Standalone (автономный)
   - 2 = Monitor (мониторинг)
   - 3 = UTC Control (удаленное управление)
5. **Controller Time** - системное время контроллера (UTMC OID: 1.3.6.1.4.1.13267.3.2.3.2.0)

### Прием SNMP traps

Проверка возможности приема SNMP traps/informs от контроллера на указанном порту.

## Интерпретация результатов

### Успешное подключение

```
=== Testing Basic Connectivity ===
Address: 192.168.4.77
Community: UTMC

1. Creating SNMP session...
   OK: Session created successfully

2. Testing GET: sysUpTime...
   OK: Received 1 varbind(s)
  [0] OID: 1.3.6.1.2.1.1.3.0                    Type: 67              Value: 1234567
```

### Ошибки подключения

Если вы видите ошибки:
- `ERROR: Failed to create SNMP session` - проверьте:
  - Доступность контроллера по сети (ping)
  - Правильность IP адреса
  - Настройки firewall
  - Правильность community string

- `ERROR: GET failed` - проверьте:
  - Community string (должен совпадать с настройками контроллера)
  - Версию SNMP (используется SNMPv2c)
  - Доступность контроллера

## Тестирование через VPN

При работе через VPN убедитесь, что:

1. **Маршрутизация**: VPN правильно маршрутизирует трафик к контроллеру
   ```bash
   ping <CONTROLLER_IP>
   ```

2. **UDP порты**: SNMP использует UDP порт 161 для запросов и указанный порт (10162) для traps
   ```bash
   # Проверка доступности SNMP порта
   nmap -sU -p 161 <CONTROLLER_IP>
   ```

3. **Firewall**: Убедитесь, что firewall разрешает SNMP трафик

## Примеры использования

### Тест подключения к тестовому контроллеру

```bash
# Прямое подключение
./build/test_controller connect 192.168.4.77 UTMC

# С использованием конфига
./build/test_controller test config.json
```

### Тест приема traps

```bash
# Запуск приемника traps на стандартном порту
./build/test_controller traps 10162 UTMC

# В другом терминале можно проверить отправку тестового trap (если есть доступ)
# snmptrap -v 2c -c UTMC localhost:10162 1.3.6.1.4.1.13267.3.2.6.1
```

## Диагностика проблем

### Проблема: Не удается создать SNMP сессию

**Возможные причины:**
- Неправильный IP адрес
- Контроллер недоступен по сети
- Firewall блокирует SNMP трафик
- Неправильный community string

**Решение:**
```bash
# Проверка доступности
ping <CONTROLLER_IP>

# Проверка SNMP порта
nmap -sU -p 161 <CONTROLLER_IP>

# Проверка с помощью стандартных SNMP утилит
snmpget -v 2c -c UTMC <CONTROLLER_IP> 1.3.6.1.2.1.1.3.0
```

### Проблема: GET запросы не возвращают данные

**Возможные причины:**
- Неправильный community string
- Контроллер не поддерживает запрашиваемые OID
- Контроллер в режиме, который не позволяет чтение

**Решение:**
- Проверьте community string в настройках контроллера
- Попробуйте стандартные SNMP OID (например, sysUpTime)
- Проверьте режим работы контроллера

### Проблема: Traps не принимаются

**Возможные причины:**
- Контроллер не настроен на отправку traps
- Неправильный порт
- Firewall блокирует входящие UDP пакеты
- Контроллер отправляет traps на другой адрес

**Решение:**
- Проверьте настройки контроллера (адрес и порт для traps)
- Убедитесь, что порт не занят другим приложением
- Проверьте firewall правила
- Используйте tcpdump для проверки входящих пакетов:
  ```bash
  sudo tcpdump -i any -n udp port 10162
  ```

## Дополнительные инструменты

Для более глубокой диагностики можно использовать стандартные SNMP утилиты:

```bash
# Установка SNMP утилит (Ubuntu/Debian)
sudo apt-get install snmp snmp-mibs-downloader

# GET запрос
snmpget -v 2c -c UTMC <CONTROLLER_IP> 1.3.6.1.4.1.13267.3.2.4.1

# WALK по дереву OID
snmpwalk -v 2c -c UTMC <CONTROLLER_IP> 1.3.6.1.4.1.13267.3.2

# Проверка traps
snmptrapd -f -Lo -p 10162
```

## Следующие шаги

После успешного тестирования подключения:

1. Проверьте работу основного приложения:
   ```bash
   ./build/spectr_utmc_cpp config.json
   ```

2. Убедитесь, что контроллер настроен на отправку traps на правильный адрес и порт

3. Проверьте логи приложения для диагностики работы в реальном времени
