# Проблема с удалённым управлением контроллером

**Дата:** 2026-02-04  
**Проблема:** Команды SET_YF не активируют жёлтое мигание, контроллер продолжает работать по заложенной программе

---

## Текущая ситуация

### Что работает:
- ✅ SNMP GET команды работают (чтение состояния)
- ✅ SNMP SET команды выполняются успешно (режим меняется на UTC Control (3))
- ✅ Контроллер доступен по сети

### Что не работает:
- ❌ Команды SET_YF не активируют жёлтое мигание визуально
- ❌ Контроллер продолжает работать по заложенной программе
- ❌ Удалённое управление не применяется

---

## Причины проблемы

### 1. Удалённое управление отключено

**Из анализа контроллера:**
```json
{
    "mode": "local",
    "remote_onoff": false,  // ⚠️ УДАЛЁННОЕ УПРАВЛЕНИЕ ВЫКЛЮЧЕНО!
    "deny_rcp": false
}
```

**Вывод:** Контроллер работает в локальном режиме, удалённое управление отключено на уровне конфигурации.

### 2. Защита от ошибок мигания

**Из логов контроллера:**
```
Deny the remote controll in case of amber flash error: True
```

**Вывод:** Контроллер имеет защиту, которая блокирует удалённое управление при ошибках мигания.

### 3. Команды принимаются, но не применяются

**Наблюдение:**
- SNMP SET команды выполняются успешно (режим меняется)
- Но контроллер продолжает работать по своей программе
- Команды SET_YF не активируют мигание

**Вывод:** Контроллер принимает команды, но игнорирует их из-за настроек безопасности или режима работы.

---

## Решения

### Вариант 1: Включить удалённое управление через веб-интерфейс

1. Открыть веб-интерфейс контроллера: `https://192.168.75.150`
2. Войти с учётными данными: `admin` / `zBCTRuV7`
3. Перейти в раздел "Управление контроллером"
4. Включить удалённое управление (`remote_onoff: true`)
5. Сохранить настройки
6. Повторить тест SET_YF

### Вариант 2: Использовать локальный сервис на контроллере

Если контроллер принимает команды только от локального сервиса (127.0.0.1):

1. Подключиться к контроллеру по SSH: `ssh voicelink@192.168.75.150`
2. Использовать `spectr_utmc.js` на контроллере для отправки команд
3. Или настроить C++ мост на роутере iRZ для работы через локальный сервис

### Вариант 3: Проверить настройки защиты

1. Проверить логи контроллера на наличие ошибок мигания
2. Если есть ошибки - исправить их
3. Сбросить защиту от ошибок мигания
4. Повторить тест

---

## Рекомендации

### Для тестирования:

1. **Включить удалённое управление через веб-интерфейс**
   - Это самый простой способ проверить, работает ли удалённое управление
   - Если после включения команды начнут работать - проблема в настройках

2. **Проверить логи контроллера**
   - Найти логи `resident` или `snmp_agent`
   - Проверить, есть ли ошибки при получении SNMP команд
   - Проверить, блокируются ли команды защитой

3. **Проверить режим работы контроллера**
   - Убедиться, что контроллер может работать в режиме UTC Control
   - Проверить, не блокируется ли режим UTC Control настройками безопасности

### Для production (роутер iRZ):

1. **Если контроллер принимает команды только от локального сервиса:**
   - C++ мост на роутере должен работать как прокси
   - Получать команды от АСУДД сервера
   - Отправлять их на локальный сервис на контроллере (если возможно)
   - Или использовать другой механизм (веб-API, если доступен)

2. **Если нужно включить удалённое управление:**
   - Настроить контроллер для приёма команд от роутера iRZ
   - Добавить IP роутера в список разрешённых источников (если есть такая настройка)
   - Или использовать другой протокол/механизм

---

## Следующие шаги

1. ✅ Попробовать включить удалённое управление через веб-интерфейс
2. ✅ Проверить логи контроллера на наличие ошибок
3. ✅ Повторить тест SET_YF после включения удалённого управления
4. ✅ Если не поможет - проверить другие настройки безопасности

---

## Вывод

Основная проблема: **Удалённое управление отключено на уровне конфигурации контроллера** (`remote_onoff: false`).

Решение: **Включить удалённое управление через веб-интерфейс контроллера** и повторить тест.
