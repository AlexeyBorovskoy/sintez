# План действий на основе анализа Node.js кода

**Дата:** 2026-02-04  
**Цель:** Понять, почему SET_YF не активирует визуальное мигание

---

## Ключевой вывод из анализа Node.js кода

**Node.js код очень простой:**
- Отправляет две SNMP команды один раз
- Нет проверок режима, фазы, времени
- Нет удержания команды
- Нет сложной логики

**Это означает:**
- Если Node.js код работает, значит контроллер **уже готов** принять команду
- Или ASUDD отправляет команду в **правильный момент**

---

## Гипотезы, почему наша реализация не работает

### Гипотеза 1: Контроллер не готов принять команду

**Проблема:** Контроллер находится в неподходящем состоянии:
- Режим работы: Standalone (1) вместо UTC Control (3)
- Нет активной фазы
- Минимальные периоды не истекли
- Идёт переходный процесс

**Решение:** Проверить состояние контроллера перед отправкой команды

### Гипотеза 2: Команда должна приходить через spectr_utmc.js

**Проблема:** Контроллер принимает команды SET_YF только через `spectr_utmc.js` на контроллере, а не напрямую через SNMP.

**Решение:** Отправить команду SET_YF через протокол Spectr-ITS на `spectr_utmc.js` на контроллере

### Гипотеза 3: Требуется другая последовательность команд

**Проблема:** Команда SET_YF требует предварительной установки фазы или других условий.

**Решение:** Попробовать последовательность:
1. Установить режим UTC Control (3)
2. Установить специальную фазу (фаза 1)
3. Дождаться минимального периода работы фазы
4. Активировать мигание (SET_YF)

### Гипотеза 4: Контроллер блокирует команду

**Проблема:** Контроллер блокирует команду SET_YF по какой-то причине:
- Настройки безопасности
- Ошибки в логах
- Другие блокировки

**Решение:** Проверить логи контроллера на наличие ошибок или блокировок

---

## План действий

### Шаг 1: Проверить состояние контроллера в реальной системе

**Цель:** Понять, в каком состоянии находится контроллер, когда ASUDD отправляет команду SET_YF

**Действия:**
1. Подключиться к контроллеру по SSH
2. Проверить текущий режим работы (`UTC_TYPE2_OPERATION_MODE`)
3. Проверить активную фазу (`UTC_REPLY_GN`)
4. Проверить режим мигания (`UTC_REPLY_FR`)
5. Проверить минимальные периоды фаз

**Команды:**
```bash
ssh voicelink@192.168.75.150
snmget -v2c -c UTMC 127.0.0.1 1.3.6.1.4.1.13267.3.2.4.1  # operationMode
snmget -v2c -c UTMC 127.0.0.1 1.3.6.1.4.1.13267.3.2.5.1.1.3  # currentPhase
snmget -v2c -c UTMC 127.0.0.1 1.3.6.1.4.1.13267.3.2.5.1.1.36  # utcReplyFR
```

### Шаг 2: Проверить логи контроллера

**Цель:** Найти ошибки или блокировки при получении команды SET_YF

**Действия:**
1. Подключиться к контроллеру по SSH
2. Проверить логи `resident` или `snmp_agent`
3. Найти сообщения об ошибках или блокировках
4. Проверить, что происходит после получения команды SET_YF

**Команды:**
```bash
ssh voicelink@192.168.75.150
journalctl -u resident -n 100
journalctl -u snmp_agent -n 100
# Или проверить файлы логов напрямую
```

### Шаг 3: Попробовать точное копирование Node.js логики

**Цель:** Убедиться, что проблема не в дополнительной логике

**Действия:**
1. Упростить C++ код до точного копирования Node.js логики
2. Убрать все проверки режима, фазы, времени
3. Убрать удержание команды
4. Отправить команду один раз

**Код:**
```cpp
bool setYF(int requestId) {
    // Точное копирование Node.js логики
    std::vector<SnmpVarbind> varbinds = {
        {UTC_TYPE2_OPERATION_MODE, SnmpType::Integer, 3},
        {UTC_CONTROL_FF, SnmpType::Integer, 1}
    };
    return snmpSet(varbinds);
}
```

### Шаг 4: Попробовать отправку команды через spectr_utmc.js на контроллере

**Цель:** Проверить, работает ли команда SET_YF через `spectr_utmc.js` на контроллере

**Действия:**
1. Подключиться к контроллеру по SSH
2. Найти способ отправки команды SET_YF через `spectr_utmc.js`
3. Или создать тестовый скрипт, который отправляет команду через протокол Spectr-ITS

**Команды:**
```bash
ssh voicelink@192.168.75.150
# Найти способ отправки команды через spectr_utmc.js
# Или создать тестовый скрипт
```

### Шаг 5: Проверить конфигурацию контроллера

**Цель:** Найти настройки, которые могут блокировать активацию мигания

**Действия:**
1. Подключиться к контроллеру по SSH
2. Проверить конфигурацию `resident`
3. Найти настройки, связанные с миганием
4. Проверить веб-интерфейс контроллера

**Команды:**
```bash
ssh voicelink@192.168.75.150
# Проверить конфигурацию resident
# Найти настройки, связанные с миганием
```

---

## Рекомендуемый порядок выполнения

1. **Сначала:** Шаг 1 (проверить состояние контроллера)
2. **Затем:** Шаг 2 (проверить логи контроллера)
3. **Потом:** Шаг 3 (точное копирование Node.js логики)
4. **Если не поможет:** Шаг 4 (отправка через spectr_utmc.js)
5. **В последнюю очередь:** Шаг 5 (проверка конфигурации)

---

## Ожидаемые результаты

### Если проблема в состоянии контроллера:
- Контроллер находится в режиме Standalone (1)
- Нет активной фазы
- Минимальные периоды не истекли

**Решение:** Добавить проверки состояния перед отправкой команды

### Если проблема в блокировке:
- В логах есть ошибки или блокировки
- Контроллер отказывается принимать команду

**Решение:** Исправить ошибки или изменить настройки

### Если проблема в способе отправки:
- Команда работает через `spectr_utmc.js`, но не напрямую через SNMP

**Решение:** Отправлять команду через протокол Spectr-ITS на `spectr_utmc.js`

---

## Важные замечания

1. **Режим ЖМ не должен отключаться автоматически** - нужна команда для перехода на другую программу управления
2. **Node.js код очень простой** - значит, проблема не в сложной логике
3. **Команда должна работать** - если Node.js код работает, значит контроллер может принимать команду
