# Промпт для Cursor: Тестирование SNMP UG405 на контроллере светофора

## Контекст проекта

Разрабатывается система управления дорожным контроллером светофора по протоколу UG405/UTMC через SNMP. Необходимо создать тестовый инструментарий для проверки различных гипотез формирования SNMP SET команд.

### Известные факты из анализа рабочего кода

**Рабочий код (spectr_utmc.js) использует:**
```javascript
// Базовые OID (без SCN!)
utmc = "1.3.6.1.4.1.13267"
utcType2OperationMode = "1.3.6.1.4.1.13267.3.2.4.1"
utcControlEntry = "1.3.6.1.4.1.13267.3.2.4.2.1"
utcControlFn = "1.3.6.1.4.1.13267.3.2.4.2.1.5"    // Force bits
utcControlLO = "1.3.6.1.4.1.13267.3.2.4.2.1.11"   // Lamps On/Off
utcControlFF = "1.3.6.1.4.1.13267.3.2.4.2.1.20"   // Flash mode
utcReplyGn = "1.3.6.1.4.1.13267.3.2.5.1.1.3"      // Current stage (Gn)

// Функция SET_PHASE (работает!)
SET_PHASE(addr, phase) {
  const p = +phase;
  return p > 0 && p < 8 ? this.set(addr, [
    {oid: "1.3.6.1.4.1.13267.3.2.4.1", type: Integer, value: 3},  // operationMode=3 (remote)
    {oid: "1.3.6.1.4.1.13267.3.2.4.2.1.5", type: OctetString, value: Buffer.of(1 << (p-1))}
  ]) : errBadParam
}
```

**Ключевое открытие:** В рабочем коде SCN НЕ включается в OID. Контроллер идентифицируется только по IP-адресу.

### Параметры контроллера

- **IP адрес:** `[ЗАМЕНИТЬ_НА_IP]` (например: 192.168.1.100)
- **SNMP Community:** `UTMC` (или `public`/`private`)
- **SNMP версия:** v2c
- **Порт:** 161 (UDP)
- **SCN (если нужен):** `[ЗАМЕНИТЬ]` (например: CO1111)

---

## Задача 1: Создать CLI утилиту для тестирования

Создай Node.js скрипт `utmc-tester.js` с CLI интерфейсом:

```bash
# Примеры использования:
node utmc-tester.js --ip 192.168.1.100 --test-connection
node utmc-tester.js --ip 192.168.1.100 --get-status
node utmc-tester.js --ip 192.168.1.100 --set-phase 3
node utmc-tester.js --ip 192.168.1.100 --set-phase 3 --scn CO1111
node utmc-tester.js --ip 192.168.1.100 --raw-set "1.3.6.1.4.1.13267.3.2.4.2.1.5" "0x04"
```

### Требования к утилите:

1. **Зависимости:** `net-snmp`, `commander` (для CLI)
2. **Режимы работы:**
   - `--test-connection` — базовая проверка связи (sysDescr)
   - `--get-status` — получить текущую фазу и режим
   - `--set-phase N` — установить фазу (1-7)
   - `--raw-set OID VALUE` — отправить произвольную команду
   - `--raw-get OID` — получить значение OID
   - `--scan` — SNMP walk по дереву 1.3.6.1.4.1.13267

3. **Опции SCN (для тестирования разных гипотез):**
   - `--scn-mode none` — не добавлять SCN (по умолчанию)
   - `--scn-mode suffix` — добавить как `.{SCN}` в конец OID
   - `--scn-mode ascii` — добавить как `.{ASCII коды}` (67.79.49.49.49.49)
   - `--scn-mode index` — добавить как `.1` (простой индекс)

4. **Логирование:**
   - Показывать отправляемый OID
   - Показывать ответ контроллера
   - Сохранять лог в файл

---

## Задача 2: Создать набор тестовых сценариев

Создай файл `test-scenarios.js` с автоматизированными тестами:

```javascript
const scenarios = [
  {
    name: "Гипотеза 1: OID без SCN (как в рабочем коде)",
    operations: [
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.1", value: 3, valueType: "Integer" },
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.2.1.5", value: "0x02", valueType: "OctetString" }
    ]
  },
  {
    name: "Гипотеза 2: OID с простым индексом .1",
    operations: [
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.1", value: 3, valueType: "Integer" },
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.2.1.5.1", value: "0x02", valueType: "OctetString" }
    ]
  },
  {
    name: "Гипотеза 3: OID с SCN в ASCII кодах",
    operations: [
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.1", value: 3, valueType: "Integer" },
      { type: "set", oid: "1.3.6.1.4.1.13267.3.2.4.2.1.5.67.79.49.49.49.49", value: "0x02", valueType: "OctetString" }
    ]
  },
  // ... дополнительные сценарии
];
```

---

## Задача 3: Создать диагностический скрипт

Создай `diagnose.js` который:

1. Выполняет SNMP WALK по всему дереву UTMC
2. Определяет какой MIB поддерживает контроллер (Simple/Full)
3. Показывает доступные объекты и их текущие значения
4. Генерирует отчёт о найденных OID

```bash
node diagnose.js --ip 192.168.1.100 --community UTMC --output report.json
```

---

## Задача 4: Shell-скрипты для быстрого тестирования

Создай `test-commands.sh`:

```bash
#!/bin/bash
IP="${1:-192.168.1.100}"
COMMUNITY="${2:-UTMC}"

echo "=== Тест 1: Без SCN ==="
snmpset -v2c -c $COMMUNITY $IP \
  1.3.6.1.4.1.13267.3.2.4.1 i 3 \
  1.3.6.1.4.1.13267.3.2.4.2.1.5 x 02

echo "=== Тест 2: С индексом .1 ==="
snmpset -v2c -c $COMMUNITY $IP \
  1.3.6.1.4.1.13267.3.2.4.1 i 3 \
  1.3.6.1.4.1.13267.3.2.4.2.1.5.1 x 02

# ... дополнительные тесты
```

---

## Структура OID для справки

```
1.3.6.1.4.1.13267          # UTMC Enterprise
├── .3                      # utmcFullUTC (UG405/Type 2)
│   └── .2                  # utcObjects
│       ├── .4              # utcControl
│       │   ├── .1          # utcType2OperationMode (Integer: 0=local, 3=remote)
│       │   └── .2.1        # utcControlEntry
│       │       ├── .5      # utcControlFn (OctetString: битовая маска фаз)
│       │       ├── .11     # utcControlLO (Integer: лампы вкл/выкл)
│       │       └── .20     # utcControlFF (Integer: мигание)
│       └── .5.1.1          # utcReplyEntry
│           ├── .3          # utcReplyGn (текущая фаза)
│           ├── .14         # utcReplySDn
│           └── .15         # utcReplyMC
└── .4                      # utmcSimpleUTC (Type 1, устаревший)
```

---

## Битовые маски фаз (utcControlFn)

| Фаза | Бит | Hex значение | Команда snmpset |
|------|-----|--------------|-----------------|
| 1    | 0   | 0x01         | `x 01`          |
| 2    | 1   | 0x02         | `x 02`          |
| 3    | 2   | 0x04         | `x 04`          |
| 4    | 3   | 0x08         | `x 08`          |
| 5    | 4   | 0x10         | `x 10`          |
| 6    | 5   | 0x20         | `x 20`          |
| 7    | 6   | 0x40         | `x 40`          |

**Формула:** `value = 1 << (phase - 1)`

---

## Режимы работы (utcType2OperationMode)

| Значение | Режим                    |
|----------|--------------------------|
| 0        | Локальное управление     |
| 3        | Удалённое управление UTC |

---

## Ожидаемые результаты тестов

### Успешный ответ:
```
SNMPv2-SMI::enterprises.13267.3.2.4.2.1.5 = Hex-STRING: 02
```

### Типичные ошибки:
- `noSuchName` — неверный OID или контроллер не поддерживает объект
- `badValue` — неверный тип или значение данных
- `genErr` — общая ошибка (проверить режим работы)
- `timeout` — нет ответа (проверить IP, порт, community)

---

## Дополнительные тесты

### Тест чтения текущего состояния:
```bash
# Получить текущую фазу
snmpget -v2c -c UTMC 192.168.1.100 1.3.6.1.4.1.13267.3.2.5.1.1.3

# SNMP WALK по дереву UTMC
snmpwalk -v2c -c UTMC 192.168.1.100 1.3.6.1.4.1.13267
```

### Тест режима работы:
```bash
# Получить текущий режим
snmpget -v2c -c UTMC 192.168.1.100 1.3.6.1.4.1.13267.3.2.4.1

# Переключить в удалённый режим
snmpset -v2c -c UTMC 192.168.1.100 1.3.6.1.4.1.13267.3.2.4.1 i 3
```

---

## Контрольный чеклист

- [ ] Проверена связь с контроллером (ping)
- [ ] Проверен SNMP community string
- [ ] Выполнен SNMP WALK для инвентаризации OID
- [ ] Протестирован GET текущей фазы
- [ ] Протестирован SET фазы БЕЗ SCN
- [ ] Протестирован SET фазы С индексом .1
- [ ] Протестирован SET фазы С SCN в ASCII
- [ ] Зафиксированы результаты каждого теста

---

## Примечания

1. **Перед SET командами** всегда убедитесь что контроллер в режиме, допускающем удалённое управление
2. **SNMP community** для записи может отличаться от community для чтения
3. **Timeout** по умолчанию 5 секунд, увеличьте при нестабильной связи
4. **Логируйте всё** — это поможет при анализе проблем
