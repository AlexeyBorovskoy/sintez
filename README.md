# spectr_utmc / sintez

Репозиторий с рабочими материалами и кодом для интеграции АСУДД с дорожным контроллером "Синтез" (UTMC/Spectr-UTMC).

Фокус: добиться надежного удаленного управления контроллером (в т.ч. режимом ЖМ, "жёлтое мигание") без Node.js-ноды в АСУДД, перенеся преобразование/мэппинг команд на уровень МФУ (OpenWrt).

## Цели

1. Стабильно включать/удерживать/выключать ЖМ на контроллере и подтверждать состояние по `utcReplyFR`.
2. Реализовать C++-компонент (аналог существующей JS-ноды), который:
   - принимает команды из сети со стороны АСУДД,
   - транслирует их в команды контроллеру (SNMP UTMC и/или Spectr-ITS),
   - обеспечивает ретраи, таймауты, подтверждение результата и возврат в штатный режим.
3. Подготовить разворачивание на МФУ под OpenWrt: сборка, конфиг, автозапуск, логирование, диагностика.

## Текущий статус (что уже есть)

1. Инструменты тестирования/снятия логов и сценарные тесты ЖМ (bash+python):
   - `tools/dk_capture.sh` (сбор логов на контроллере через SSH)
   - `tools/yf_scripted_test.sh` (сценарий ЖМ 60s -> штатно -> пауза -> ЖМ 60s -> штатно)
   - `tools/yf_make_report.py` (генерация `report.md` по результатам прогона)
   - отчеты и артефакты: `spectr_utmc/controller_snapshot/experiments/...`
2. C++ утилита для тестов SNMP и прикладного сценария ЖМ:
   - `spectr_utmc/spectr_utmc_cpp/build/test_controller`
   - команда `ssh_yf_for` включает ЖМ на N секунд и возвращает в штатный режим через SSH + локальный SNMP на контроллере.

## Важные наблюдения по ЖМ (по тестам)

На данном контроллере команда включения ЖМ работает надежнее в режиме:

1. Перевод в `operationMode=3` (UTC Control)
2. Переотправка `utcControlFF=1` до подтверждения по `utcReplyFR != 0`
3. Для удержания ЖМ периодически повторять `utcControlFF=1`
4. Возврат в штатный режим: `utcControlLO=0`, `utcControlFF=0`, `operationMode=1`

OID (используются в тестах):
- `operationMode`: `1.3.6.1.4.1.13267.3.2.4.1`
- `utcControlFF` (SetAF): `1.3.6.1.4.1.13267.3.2.4.2.1.20`
- `utcControlLO`: `1.3.6.1.4.1.13267.3.2.4.2.1.11`
- `utcReplyFR`: `1.3.6.1.4.1.13267.3.2.5.1.1.36`

## Быстрый старт (локально)

### Сборка C++ (Linux)

```bash
cd spectr_utmc/spectr_utmc_cpp
cmake -S . -B build
cmake --build build -j
```

### Тест ЖМ на 30 секунд средствами C++

Команда использует SSH к контроллеру и запускает `snmpset/snmpget` на самом контроллере (на `127.0.0.1`), поэтому нужен SSH-пароль.

```bash
# пароль можно хранить в файле (1 строка), права 600
spectr_utmc/spectr_utmc_cpp/build/test_controller \
  ssh_yf_for 192.168.75.150 UTMC 30 voicelink 120 2 /tmp/dk_pass
```

Ожидаемый признак успеха:
- строка `CONFIRMED: utcReplyFR=1`
- после восстановления: `mode=1 fr=0`

### Сценарный тест ЖМ (bash)

```bash
DK_PASS=... tools/yf_scripted_test.sh --confirm
```

Результаты сохраняются в `spectr_utmc/controller_snapshot/experiments/<timestamp>_yf_scripted_test/` вместе с `report.md`.

## Структура репозитория

- `spectr_utmc/spectr_utmc_cpp/`
  - C++ реализация работы с SNMP (net-snmp) и тестовый контроллерный CLI.
- `tools/`
  - сценарные тесты и сбор логов с контроллера.
- `spectr_utmc/controller_snapshot/`
  - дампы/снимки состояния контроллера и результаты экспериментов.

## План работ (задачи)

1. MFU/OpenWrt:
   - кросс-сборка `spectr_utmc_cpp` под OpenWrt (toolchain/SDK),
   - упаковка в пакет (opkg) или единый бинарник,
   - автозапуск через `procd`, логирование в `logread`.
2. Прокси вместо JS-ноды:
   - поднять на МФУ сервис (TCP/HTTP) для приема команд АСУДД,
   - реализовать мэппинг команд АСУДД -> действия контроллера,
   - обеспечить подтверждение результата (по `utcReplyFR` и др.) и таймауты.
3. Надежность:
   - ретраи, reconnection, rate limit,
   - watchdog/healthcheck,
   - аккуратное поведение при `Ctrl+C`/сигналах (обязательный возврат в штатный режим при прерывании).
4. Безопасность:
   - убрать пароли/секреты из репозитория, хранить в конфиге/секрет-хранилище,
   - ротация тестовых учетных данных при публикации наружу.

