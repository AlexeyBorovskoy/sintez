# Заметки по ревью C++ (для внешнего инженера)

Проверенный объем:
- `spectr_utmc/spectr_utmc_cpp/src/*.cpp`
- `spectr_utmc/spectr_utmc_cpp/include/*.h`

## Ключевые находки и внесенные исправления

1. Data race в `TcpClient` на `sendQueue_`
- Ранее код проверял `sendQueue_.empty()` без удержания `sendMutex_`.
- Исправлено: теперь мьютекс берется до проверки (устраняет UB по модели памяти C++).

2. `ConfigLoader::load` не сбрасывал выходной объект
- При повторном вызове `ConfigLoader::load()` на одном и том же объекте `Config` могли “накопиться” старые значения.
- Исправлено: в начале загрузки делается сброс `config` и очистка `objects`.
- Убран дублирующийся чек `No objects configured`.

3. Самодостаточность заголовка `object_manager.h`
- Заголовок использовал `std::thread`, но не включал `<thread>`.
- Исправлено добавлением `#include <thread>`.

4. Неиспользуемая переменная в `main.cpp`
- Удалена неиспользуемая переменная `targetId`.

## Поведенческие заметки

- Мост сейчас работает как клиент Spectr stream (сам подключается к `its.host:its.port`).
- ЖМ (`SET_YF`) реализовано через keepalive-логику:
  - периодически (пере)посылает `utcControlFF=1`, пока ЖМ активно,
  - пытается подтвердить включение по `utcReplyFR` за время `yf.confirmTimeoutSec`,
  - keepalive останавливается при приходе других управляющих команд (`SET_LOCAL`, `SET_OS`, `SET_PHASE`, `SET_START`).

## Известные пробелы / что проверить дальше

- OpenWrt упаковка сейчас в формате “скелет”: сборку нужно делать в корректном SDK и проверить реальные имена/зависимости пакетов `libnetsnmp` для фидов OpenWrt 19.07.
- `ConfigLoader` это минималистичный JSON-парсер; для промышленной эксплуатации стоит перейти на полноценную JSON-библиотеку либо на UCI-конфиг (OpenWrt-канонично).
